---
title: "Elixir biohackathon 2021"
output: 
  flexdashboard::flex_dashboard:
    storyboard: true
    theme: 
      bootswatch: minty
    css: extra.css
runtime: shiny
theme: journal
---

```{r global, include=FALSE}
library(flexdashboard)
library(shiny)
library(shinydashboard)
library(tidyverse)

theme_set(theme_classic() + theme(text = element_text(size=16,face="bold")))

```

```{r data}
#https://stats.stackexchange.com/questions/495981/update-beta-distributed-prior-with-data-that-is-a-probability
N=1000
p=0.5
n=1000
a=1+p*n
b=1+(n-p*n)

subtype_distributions =
    list(
        "Not certain" = function()rbeta(N,10,10),
        "More-than-not certain" = function()rbeta(N,2,1),
        "Kinda certain" = function()rbeta(N,3,1),
        "Sorta certain" = function()rbeta(N,4,1),
        "Pretty certain" = function()rbeta(N,5,1)
    )

certainty_probas <- 
    list(
        "Not certain" = 0.2,
        "More-than-not certain" = 0.4,
        "Kinda certain" = 0.6,
        "Sorta certain" = 0.8,
        "Pretty certain" = 0.99
    )
  
cms1probas <- subtype_distributions[["Not certain"]]()
cms2probas <- subtype_distributions[["Not certain"]]()
cms3probas <- subtype_distributions[["Not certain"]]()
cms4probas <- subtype_distributions[["Pretty certain"]]()

example_subtype_credible_data <- 
    tibble(
        lwr = c(
            quantile(cms1probas,c(0.025)) %>% unname,
            quantile(cms2probas,c(0.025)) %>% unname,
            quantile(cms3probas,c(0.025)) %>% unname,
            quantile(cms4probas,c(0.025)) %>% unname
        ),
        m = c(
            mean(cms1probas),
            mean(cms2probas),
            mean(cms3probas),
            mean(cms4probas)
        ),
        upr = c(
            quantile(cms1probas,c(0.975)) %>% unname,
            quantile(cms2probas,c(0.975)) %>% unname,
            quantile(cms3probas,c(0.975)) %>% unname,
            quantile(cms4probas,c(0.975)) %>% unname
        ),
        subtype = c(
            "CMS1",
            "CMS2",
            "CMS3",
            "CMS4"
        )
    )
```

Welcome
=====

```{r}

fluidPage(
  fluidRow(
    div(
      class = "welcome",
      "Disease is a mixture! Different molecular characteristics make up different types of disease. Moreover, different data types, such as gene expression, probe these characteristics differently. Each disease subtype is susceptible to treatment options to deliver better patient care. How confident are we in disease subtyping? We introduce this problem and potential solution using colorectal cancer."
    )
  ),
  fluidRow(
    box(
      h3("Are you a researcher interested in subtyping disease? Choose 'For researchers' above"),
      img(class="icon",src="researcher.png")
    ),
    box(
      h3("Are you a physician scientist interested in treatment options for your patient? Choose 'For physician scientists' above"),
      img(class="icon",src="clinician.png")
    ),
    box(
      h3("Are you a developer interested in how the bayesian inference is done? Choose 'For developers' above"),
      img(class="icon",src="developer.png")
    )
  ),
  fluidRow(
      column(
        12,
        div(
        style="display: block;margin-left: auto;margin-right: auto;font-weight: bold; word-wrap: break-word;",
        actionButton(
          "goButton", 
          "To get started without errors, click here"
          )
        )
      )
      )
)
```


For researchers {.storyboard}
======

### Overview

```{r}

fluidPage(
  fluidRow(
    column(
      12,
      div(
        class="description",
        "Colorectal cancer (CRC) is a heterogeneous cancer that has been recently deep-profiled for molecular characteristics. ",
        img(class="medium-pic",src="CRC.png"),
        "We next detail the groups of CRC based on molecular characteristics."
        )
      )
    ),
    fluidRow(
    column(
      12,
      div(
      class="description",
      "There are four molecular subtypes i.e. the consensus molecular subtype (CMS) that explain colorectal cancers.",
      br(),
      a(href="https://www.nature.com/articles/nm.3967","The CMS is a subtyping classification based on marker expression data across expert groups")
    )
    )
  ),
  fluidRow(
    column(
      12,
      img(class="medium-pic",src="nihms-1039672-f0002.jpeg")
    )
  ),
  fluidRow(
    column(
      12,
      div(
      class="description",
      "By knowing which molecular characteristics are present in our data, we can 'update' our prior belief of which subtypes may be present in our cohort. Furthermore, which type of data we have available will change how confident we are in defining those molecular characteristics."
    )
    )
  )
  )
```

### Subtyping your data

```{r json_graph}

graph_lst <- jsonlite::read_json("initial-graph.json",simplifyVector = T)

```

```{r cms_types}

fluidPage(
  fluidRow(
    column(
      12,
      div(
        class="description",
        "How confident are you in the CRC subtypes in your dataset, how large is your cohort, and which datatypes did you use to identify them?"
        )
      )
    ),
  fluidRow(
    column(
      12,
      div(
        textInput("cohort_size",h4("Cohort size"),value=c(100),placeholder = 100)
      )
    )
  ),
  fluidRow(
    div(
      style="description",
      align = "center",
      checkboxGroupInput(
        "multidata",
        label = h4("Data types"),
        choices = c("Bulk RNA","ssRNA","PRS","miRNA","NanoString"),
        selected="Bulk RNA"
        )
    )
  ),
  fillRow(
      div(
        h4("CMS1: "),
        radioButtons(
          inputId = "cms1",
          label="",
          choices = c(
            "Not certain",
            "More-than-not certain",
            "Kinda certain",
            "Sorta certain",
            "Pretty certain"
            ),
          selected = "Not certain"
          )
        ),
      div(
        h4("CMS2: "),
        radioButtons(
          inputId = "cms2",
          label="",
          choices = c(
            "Not certain",
            "More-than-not certain",
            "Kinda certain",
            "Sorta certain",
            "Pretty certain"
            ),
          selected = "Not certain"
          )
        ),
      div(
        h4("CMS3: "),
        radioButtons(
          inputId = "cms3",
          label="",
          choices = c(
            "Not certain",
            "More-than-not certain",
            "Kinda certain",
            "Sorta certain",
            "Pretty certain"
            ),
          selected = "Not certain"
          )
        ),
      div(
        h4("CMS4: "),
          radioButtons(
            inputId = "cms4",
          label="",
          choices = c(
            "Not certain",
            "More-than-not certain",
            "Kinda certain",
            "Sorta certain",
            "Pretty certain"
            ),
            selected = "Not certain"
            )
         )
    )
  )

```

```{r reactivity}
subtypeProbas <- reactiveValues()

cohort_size <- reactive({input$cohort_size %>% as.numeric()})
cms_multidata <- 
      reactive({
        graph_lst$edges %>% 
        filter(from %in% input$multidata &
                 !is.na(title)) %>% 
        distinct(from,value) %>% 
        summarize(s = max(value)) %>% 
        unlist %>% unname %>% as.numeric()
      })
cms1 <- reactive({certainty_probas[[input$cms1]] %>% as.numeric()})
cms1_multiproba <- 
      reactive({
        graph_lst$edges %>% 
        filter(to=="CMS1" & 
                 from %in% input$multidata &
                 is.na(title)) %>% 
        distinct(from,value) %>% 
        summarize(s = max(value)) %>% 
        unlist %>% unname %>% as.numeric()
      })
cms1p <- reactive({cms1()*cms1_multiproba()})
subtypeProbas$cms1_probas <- 
  reactive({
    rbeta(
      N,
      1+cms1p()*cohort_size(),
      1+(cohort_size()-cms1p()*cohort_size())
      )
    })
cms2 <- reactive({certainty_probas[[input$cms2]] %>% as.numeric()})
cms2_multiproba <- 
      reactive({
        graph_lst$edges %>% 
        filter(to=="CMS2" & 
                 from %in% input$multidata &
                 is.na(title)) %>% 
        distinct(from,value) %>% 
        summarize(s = max(value)) %>% 
        unlist %>% unname %>% as.numeric()
      })
cms2p <- reactive({cms2()*cms2_multiproba()})
subtypeProbas$cms2_probas <- 
  reactive({
    rbeta(
      N,
      1+cms2p()*cohort_size(),
      1+(cohort_size()-cms2p()*cohort_size())
      )
    })
cms3 <- reactive({certainty_probas[[input$cms3]] %>% as.numeric()})
cms3_multiproba <- 
      reactive({
        graph_lst$edges %>% 
        filter(to=="CMS3" & 
                 from %in% input$multidata &
                 is.na(title)) %>% 
        distinct(from,value) %>% 
        summarize(s = max(value)) %>% 
        unlist %>% unname %>% as.numeric()
      })
cms3p <- reactive({cms3()*cms3_multiproba()})
subtypeProbas$cms3_probas <- 
  reactive({
    rbeta(
      N,
      1+cms3p()*cohort_size(),
      1+(cohort_size()-cms3p()*cohort_size())
      )
    })
cms4 <- reactive({certainty_probas[[input$cms4]] %>% as.numeric()})
cms4_multiproba <- 
      reactive({
        graph_lst$edges %>% 
        filter(to=="CMS4" & 
                 from %in% input$multidata &
                 is.na(title)) %>% 
        distinct(from,value) %>% 
        summarize(s = max(value)) %>% 
        unlist %>% unname %>% as.numeric()
      })
cms4p <- reactive({cms4()*cms4_multiproba()})
subtypeProbas$cms4_probas <- 
  reactive({
    rbeta(
      N,
      1+cms4p()*cohort_size(),
      1+(cohort_size()-cms4p()*cohort_size())
      )
    })

subtypeProbasDT <- 
    reactive({
        tibble(
            values = c(
                subtypeProbas$cms1_probas(),
                subtypeProbas$cms2_probas(),
                subtypeProbas$cms3_probas(),
                subtypeProbas$cms4_probas()
            ),
            subtype = c(
                rep("CMS1",N),
                rep("CMS2",N),
                rep("CMS3",N),
                rep("CMS4",N)
                )
        )
    })

observe({
    shinyjs::toggleElement(id="chance_text_div",condition=!is.na(input$multidata))
  })

```

### Subtyping confidence

```{r credible_data}

fluidPage(
  fluidRow(
    column(
      12,
      div(
      class="description",
      "Of the previous evidence, we are this certain of our CRC subtyping:"
      ),
      div(
        style="font-size: 30px; text-align: center;",
        renderText(
          {
            tab <- 
              subtypeProbasDT() %>% 
              group_by(subtype) %>% 
              summarize(m = mean(values)) %>% 
              arrange(m) %>% 
              tail(1)
          name <- 
              tab %>% select(subtype) %>% unlist %>% unname
          name
          }
        )
      ),
      div(
      renderGauge(
        {
          tab <- 
              subtypeProbasDT() %>% 
              group_by(subtype) %>% 
              summarize(m = mean(values)) %>% 
              arrange(m) %>% 
              tail(1)
          val <- 
              tab %>% select(m) %>% unlist %>% unname
          name <- 
              tab %>% select(subtype) %>% unlist %>% unname
          gauge(
            round(val,2),
            min = 0, max = 1, 
            label = "",symbol = '%', 
            gaugeSectors(
              success = c(50, 100), warning = c(30, 49), danger = c(0, 29),
              colors = c("green", "orange", "red")
              )
          )
        }
      )
      )
    )
    ),
  fluidRow(
    column(
      12,
      align="center",
      div(
        style="font-size: 20px; text-align: left;",
        "Here is our uncertainty in defining CRC subtypes in our data:"
      ),
      div(
      renderPlot(
        {
        subtypeProbasDT() %>% 
                group_by(subtype) %>% 
                summarize(
                    lwr = mean(values) - sd(values),
                    m = mean(values),
                    upr = mean(values) + sd(values)
                ) %>% 
                ggplot(aes(m,subtype)) + 
                geom_point() + 
                geom_errorbarh(
                    aes(xmin=lwr,xmax=upr),
                    height=0.1
                    ) +
                scale_x_continuous(lim=c(0,1)) + 
                xlab("Credible Interval") + 
                ylab("") + 
                theme(
                    legend.position = "none",
                    axis.ticks.y = element_blank(),
                    axis.line.y  = element_blank(),
                    axis.text.x = element_text(size=10,face="bold")
                    )
        
        },
        height = 200,
        width=800,
        )
      )
    )
    ),
  fluidRow(
    column(
      12,
      div(
        class="description",
        "Collecting more data with other datatypes may change your CRC subtyping. Go back, change parameters, and see how you can increase your subtyping abilities!"
      )
    )
  )
  )

```


For physician scientists {.storyboard}
======

### Overview of colorectal cancer (CRC)

### CRC subtyping and treatment

### Your patient's CRC data

### Treatment option confidence

For developers
======

```{r}

fluidPage(
  fluidRow(
    column(
      12,
      h3("Not certain for any CRC subtype"),
      renderPlot(
        {
            tibble(
              subtype = c(
                  rep("CMS1",N),
                  rep("CMS2",N),
                  rep("CMS3",N),
                  rep("CMS4",N)),
              probability = c(
                  subtype_distributions[["Not certain"]](),
                  subtype_distributions[["Not certain"]](),
                  subtype_distributions[["Not certain"]](),
                  subtype_distributions[["Not certain"]]()
                  )
          ) %>% 
              ggplot(aes(probability,color=subtype)) +
              geom_density() +
              xlab("Probability") +
              ylab("Likelihood")
        },height = 300
      )
    )
  ),
  fluidRow(
    column(
      12,
      h3("Pretty certain for one CRC subtype"),
      renderPlot(
        {
          tibble(
            subtype = c(
                rep("CMS1",N),
                rep("CMS2",N),
                rep("CMS3",N),
                rep("CMS4",N)),
            probability = c(
                subtype_distributions[["Pretty certain"]](),
                subtype_distributions[["Not certain"]](),
                subtype_distributions[["Not certain"]](),
                subtype_distributions[["Not certain"]]()
                )
        ) %>% 
            ggplot(aes(probability,color=subtype)) +
            geom_density() +
            xlab("Probability") +
            ylab("Likelihood")
        },height=300
      )
    )
  )
)
```
